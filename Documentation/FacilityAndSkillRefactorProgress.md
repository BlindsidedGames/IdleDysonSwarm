# Refactor Progress Tracker

## How to Use
- Update this file after each completed step or phase.
- If interrupted, the next agent should read this file first and resume from the last entry.

## Current Phase
- Phase: Phase 8 (generic building presenter)
- Owner: Codex
- Date: 2026-01-12

## Last Completed
- Added save gating and autosave scheduling guardrails in `Assets/Scripts/Expansion/Oracle.cs`.
- Added saveVersion + migration scaffolding fields and hooks.
- Added RefactorProgress tracking instructions in `Documentation/FacilityAndSkillRefactor.md`.
- Added initial data assets and stat pipeline scaffolding (definitions, databases, stat calculator).
- Added facility runtime scaffolding (state, breakdown, runtime).
- Added legacy bridge to compute Assembly Line production via new stat pipeline.
- Added debug context menu to compare Assembly Line production (legacy vs pipeline).
- Updated debug comparison to use inline legacy formula and report inputs.
- Adjusted legacy bridge to use float-precision base production for parity.
- Added AI Manager legacy bridge and debug comparison hook.
- Added Server legacy bridge and debug comparison hook.
- Added Data Center and Planet legacy bridges and debug comparison hooks.
- Added Data Center extras (rudimentary singularity + parallel computation) to legacy bridge.
- Added Planet pocket dimensions chain to legacy bridge and aligned pocket protectors gating.
- Updated planet runtime and debug comparisons to include prestige data and extra modifiers.
- Added a debug context menu to run parity checks with temporary test values (Data Centers + Planets).
- Updated stat calculator to apply effects strictly by order so additive effects can be applied after multipliers.
- Added rudimentary singularity parity check and expanded the temporary parity runner to cover it.
- Verified rudimentary singularity parity via temporary test run (delta 0).
- Added planet generation pipeline (scientific planets, planet assembly, shell worlds, stellar sacrifices) with parity debug.
- Expanded the temporary parity runner to cover assembly lines, AI managers, and servers in sequence.
- Consolidated parity menu entries into a single suite and added tests for stellar sacrifice bot drain + shoulders-of-the-fallen bonuses.
- Added shoulders-of-giants/what-could-have-been accrual parity tests and added stellar sacrifice variant scenarios.
- Verified parity suite run: all deltas zero (facility chain + planet generation + stellar sacrifice + shoulders accruals).
- Added ScriptableObject-driven effect pipeline scaffolding (effect context, condition evaluator, skill effect provider, facility effect pipeline).
- Added editor tool to generate core facility skill/effect assets (rule34, stayingPower, superchargedPower, rudimentarySingularity, parallelComputation, pocketDimensions).
- Added dynamic value resolution for core facility effects in SkillEffectProvider.
- Added data-driven parity output in facility comparisons when skill/effect assets are present.
- Added parity suite summary log that reports any nonzero deltas.
- Aligned data-driven base production with legacy float precision and set rudimentary singularity flag in parity suite.
- Verified parity suite with data-driven effects: all deltas within epsilon.
- Added full skill effect catalog pass (core production + modifiers + global multipliers + shoulders accruals).
- Added shoulder surgery bonus to pocket dimensions data-driven effect.
- Added shoulders-of-precursors money override and fixed skill id extraction for dynamic effects.
- Matched legacy float constants for staying power and parallel computation to remove tiny parity drift.
- Swapped facility production in `ProductionSystem` to prefer data-driven runtimes with legacy fallbacks.
- Preserved parallel computation server increment behavior while using data-driven production rates.
- Restored pocket dimensions production to legacy (shoulder surgery bonus no longer affects facility output).
- Ran parity suite after facility swap: all deltas within epsilon.
- Short play session with `GameDataRegistry` in scene: no visible issues.
- Moved planet generation + shoulders accrual calculations to data-driven pipeline with legacy fallback.
- Moved money/science multipliers and panels-per-second to data-driven pipeline with legacy fallback.
- Added a debug context menu to log data-driven breakdowns for facilities + global stats.
- Added a facility modifier pipeline (terra thresholds + infinity buffs + secrets + Avocato) with legacy fallback.
- Updated modifier calculations to prefer data-driven results and extracted legacy modifier helpers.
- Added facility modifier parity checks to the parity suite.
- Adjusted server modifier effect ordering (cluster networking/parallel processing) to align with legacy order.
- Matched float constants for server modifier log multipliers to remove tiny parity drift.
- Added research data scaffolding (definitions/database) and registry + asset creator wiring.
- Expanded `Documentation/FacilityAndSkillRefactor.md` with a research migration phase and updated setup/validation notes.
- Integrated modifier breakdown contributions into facility production effects.
- Added a secrets-only helper for modifier breakdowns to avoid mutating upgrade percents.
- Updated data-driven parity comparisons to use modifier pipeline expected values.
- Added `SkillIdMap` for legacy key to id mapping and wired it into the asset creator.
- Added skill ownership + auto-assign id lists to save data with migration hooks (saveVersion 2).
- Added `SkillFlagAccessor` and updated `SkillEffectProvider` to prefer id ownership with dvst fallback.
- Updated skill tree UI and auto-assignment scripts to use `SkillDefinition`/skill ids with legacy fallbacks.
- Added Oracle helpers for skill ownership, auto-assignment id conversion, and skill reset.
- Play-mode sanity check: skill tree interactions functioning as normal (user report).
- Synced skill id ownership from dvst during parity suite to avoid stale id-based effects in debug runs.
- Added research id map + research level save migration (saveVersion 3) with `researchLevelsById`.
- Added research effect provider and wired research effects into global multipliers + facility modifiers.
- Updated shoulders accruals + research upgrade components to use id-based research levels.
- Added panel lifetime stat pipeline with legacy fallback + parity suite check hook.
- Added editor tool to create core research definitions/effects using current scene costs.
- Logged panel lifetime breakdowns in the data-driven debug output.
- Research UI now pulls cost/name from `ResearchDefinition` assets when available.
- Facility modifier breakdown now folds additive upgrade contributions into the base multiplier (avoids fallback).
- Added parity checks for money/science multipliers.
- Ran facility parity suite after research migration: all deltas within epsilon (31 results).
- Updated research asset creator to pull cost/exponent/name defaults from in-scene research components when available.
- Added tinker stats to the data-driven pipeline and wired `ManualBotCreation` to use them (bot yield, assembly yield, cooldown).
- Added `FacilityRuntimeBuilder` helper and updated production + Oracle breakdowns to use it.
- Added `FacilityBreakdownPopup` and `FacilityPresenter` scripts for UI breakdown wiring.
- Removed legacy fallback formulas in `ProductionSystem` and `ModifierSystem` so data-driven stats are authoritative.
- Ran editor tools to generate core research definitions, game data assets/registry, and refreshed skill definitions + effects (including tinker effects).
- Wired `FacilityBreakdownPopup` and `FacilityPresenter` in the Game scene and added a close button for the popup.
- Added running totals to facility breakdown entries for clarity.
- Passed prestige context into facility production runtimes so on-card values match breakdown totals.
- Completed play-mode sanity checks (research labels/costs, auto-buy toggles, panel lifetime upgrades, manual tinker, skill tree flows).
- Added `FacilityBuildingPresenter` and collapsed per-facility managers into thin wrappers.
- Updated `BotsAutoBuy` to reference the generic presenter base.
- Moved facility cost/exponent + display verb fields into `FacilityDefinition` assets and updated the presenter to use them.
- Building UI references now live directly on `Building` (no `BuildingReferences` field); added a migration tool to copy existing references.
- Reintroduced `BuildingReferences` as the primary UI wiring and hid redundant inspector fields in `Building`.
- Removed legacy manager scripts and wired the scene to use `FacilityBuildingPresenter` directly.
- Removed stale UnityEvent targets referencing `DataCenterManager` from scene/prefab button handlers.
- Removed default facility-type auto-assign logic in `FacilityBuildingPresenter` after manager wrappers were removed.
- Renamed `dvid`/`dvpd`/`dvst`/`pp` identifiers to descriptive names across the project; fixed `AvocadoFeeder` infinity point feed type.
- Reviewed secrets-of-the-universe integration: `SecretBuffState` feeds data-driven facility/global multipliers with breakdown entries (no data center secret multiplier, matching legacy).
- Added explicit secrets-of-the-universe upgrade-percent contributions in facility modifier breakdowns (assembly/manager/server/planet upgrades).

## In Progress
- None

## Next Steps
- Load an existing save to confirm skill ownership + auto-assign lists migrate correctly.
- Verify breakdown UI in play mode (open/close + totals match cards).

## Files Touched
- `Documentation/FacilityAndSkillRefactor.md`
- `Documentation/FacilityAndSkillRefactorProgress.md`
- `Assets/Scripts/Expansion/Oracle.cs`
- `Assets/Scripts/Expansion/ResearchManager.cs`
- `Assets/Scripts/AutomationButtonEnabler.cs`
- `Assets/Scripts/AvocadoFeeder.cs`
- `Assets/Scripts/InfinityManager.cs`
- `Assets/Scripts/PrestigeFillBar.cs`
- `Assets/Scripts/PrestigePlusUpdater.cs`
- `Assets/Scripts/StoryManager.cs`
- `Assets/Scripts/ToRealityFillbar.cs`
- `Assets/Scripts/Buildings/BuildingsOverlord.cs`
- `Assets/Scripts/Buildings/BotPanelManager.cs`
- `Assets/Scripts/Buildings/ManualBotCreation.cs`
- `Assets/Scripts/Buildings/FacilityBuildingPresenter.cs`
- `Assets/Scripts/Buildings/AssemblyLineManager.cs` (deleted)
- `Assets/Scripts/Buildings/ManagerManager.cs` (deleted)
- `Assets/Scripts/Buildings/ServerManager.cs` (deleted)
- `Assets/Scripts/Buildings/DataCenterManager.cs` (deleted)
- `Assets/Scripts/Buildings/PlanetManager.cs` (deleted)
- `Assets/Scripts/Buildings/BotsAutoBuy.cs`
- `Assets/Scripts/Buildings/Building.cs`
- `Assets/Scripts/Buildings/BuildingReferences.cs`
- `Assets/Scripts/Research/Research.cs`
- `Assets/Scripts/Research/ResearchEnabler.cs`
- `Assets/Scripts/Research/ResearchOverlord.cs`
- `Assets/Scripts/Research/AssemblyLineUpgrade.cs`
- `Assets/Scripts/Research/AiManagerUpgrade.cs`
- `Assets/Scripts/Research/ServerManagerUpgrade.cs`
- `Assets/Scripts/Research/DataCenterManagerUpgrade.cs`
- `Assets/Scripts/Research/PlanetManagerUpgrade.cs`
- `Assets/Scripts/Research/MoneyMultiUpgrade.cs`
- `Assets/Scripts/Research/ScienceBoostUpgrade.cs`
- `Assets/Scripts/SkillTresStuff/LineManager.cs`
- `Assets/Scripts/SkillTresStuff/SetSkillsOnOracle.cs`
- `Assets/Scripts/SkillTresStuff/SkillsAutoAssignment.cs`
- `Assets/Scripts/SkillTresStuff/SkillTreeConfirmationManager.cs`
- `Assets/Scripts/SkillTresStuff/SkillTreeManager.cs`
- `Assets/Scripts/User Interface/BotDistributionSlider.cs`
- `Assets/Scripts/User Interface/DebugOptions.cs`
- `Assets/Scripts/User Interface/MenuTogglesInitializer.cs`
- `Assets/Scripts/User Interface/SidePanelManager.cs`
- `Assets/Scripts/User Interface/WikiCategoryEnabler.cs`
- `Assets/Scripts/PanelLifetime1.cs`
- `Assets/Scripts/Data/ResearchIdMap.cs`
- `Assets/Scripts/Data/FacilityDefinition.cs`
- `Assets/Scripts/Data/SkillDefinition.cs`
- `Assets/Scripts/Data/EffectDefinition.cs`
- `Assets/Scripts/Data/ResearchDefinition.cs`
- `Assets/Scripts/Data/FacilityDatabase.cs`
- `Assets/Scripts/Data/SkillDatabase.cs`
- `Assets/Scripts/Data/ResearchDatabase.cs`
- `Assets/Scripts/Data/EffectDatabase.cs`
- `Assets/Scripts/Data/GameDataRegistry.cs`
- `Assets/Scripts/Data/SkillIdMap.cs`
- `Assets/Scripts/Systems/GameManager.cs`
- `Assets/Scripts/Systems/ModifierSystem.cs`
- `Assets/Scripts/Systems/OfflineProgressSystem.cs`
- `Assets/Scripts/Systems/ProductionMath.cs`
- `Assets/Scripts/Systems/ProductionSystem.cs`
- `Assets/Scripts/Systems/Facilities/FacilityState.cs`
- `Assets/Scripts/Systems/Facilities/FacilityBreakdown.cs`
- `Assets/Scripts/Systems/Facilities/FacilityRuntime.cs`
- `Assets/Scripts/Systems/Facilities/FacilityLegacyBridge.cs`
- `Assets/Scripts/Systems/Facilities/FacilityEffectPipeline.cs`
- `Assets/Scripts/Systems/Facilities/FacilityRuntimeBuilder.cs`
- `Assets/Scripts/Systems/Facilities/FacilityBreakdownPopup.cs`
- `Assets/Scripts/Systems/Facilities/FacilityPresenter.cs`
- `Assets/Scripts/Systems/Stats/EffectConditionEvaluator.cs`
- `Assets/Scripts/Systems/Stats/ResearchEffectProvider.cs`
- `Assets/Scripts/Systems/Stats/SkillEffectProvider.cs`
- `Assets/Scripts/Systems/Stats/SkillFlagAccessor.cs`
- `Assets/Scripts/Systems/Stats/SkillEffectCatalog.cs`
- `Assets/Scripts/Systems/Stats/FacilityModifierPipeline.cs`
- `Assets/Scripts/Systems/Stats/GlobalStatPipeline.cs`
- `Assets/Scripts/Systems/Stats/StatOperation.cs`
- `Assets/Scripts/Systems/Stats/StatEffect.cs`
- `Assets/Scripts/Systems/Stats/Contribution.cs`
- `Assets/Scripts/Systems/Stats/StatResult.cs`
- `Assets/Scripts/Systems/Stats/StatCalculator.cs`
- `Assets/Scripts/Systems/Stats/StatRef.cs`
- `Assets/Scripts/Systems/Stats/StatId.cs`
- `Assets/Editor/GameDataAssetCreator.cs`
- `Assets/Editor/FacilityDefinitionSync.cs`
- `Assets/Data/Databases/EffectDatabase.asset`
- `Assets/Data/Facilities/assembly_lines.asset`
- `Assets/Data/Facilities/ai_managers.asset`
- `Assets/Data/Facilities/servers.asset`
- `Assets/Data/Facilities/data_centers.asset`
- `Assets/Data/Facilities/planets.asset`
- `Assets/Data/Skills/manualLabour.asset`
- `Assets/Data/Skills/versatileProductionTactics.asset`
- `Assets/Data/Effects/effect.manualLabour.tinker_assembly_yield.asset`
- `Assets/Data/Effects/effect.versatileProductionTactics.tinker_assembly_yield.asset`
- `Assets/Scenes/Game.unity`
- `Assets/Prefabs/Buildings/Building.prefab`

## Manual Unity Editor Steps Pending
- None currently noted.

## Save Migration Status
- saveVersion: v3 (research levels migration)
- SkillIdMap: runtime mapping added
- Migration steps applied: legacy skill ownership + auto-assign lists -> id-based
- Migration steps applied: legacy research upgrade counts -> `researchLevelsById`

## Validation Status
- Parity checks: Assembly Lines, AI Managers, Servers, Data Centers, Planets matched base formulas and extra modifiers.
- Parity checks: Planet generation matched base formulas.
- Parity checks: Stellar sacrifice bot drain, shoulders-of-the-fallen bonuses, shoulders-of-giants/what-could-have-been accruals matched.
- Parity checks: Facility modifier parity checks run (passed).
- Parity checks: Panel lifetime parity check run (passed).
- Data-driven effects: assets regenerated and parity suite rerun; deltas within acceptable parameters.
- Research data scaffolding: assets generated and database assigned in scene.
- Research data migration: research levels dictionary + pipeline integration in place; parity suite run for global stats.
- Modifier breakdown integration: parity suite re-run after breakdown changes (passed).
- Data-driven facility parity comparisons updated (parity suite re-run passed).
- Data-driven runtime is now authoritative (legacy fallback in production/modifier paths removed).
- Tinker pipeline added; assets regenerated; play-mode verification pending.
- Offline simulation: parity harness added; 1s step run shows sub-1% drift.
- Secrets-of-the-universe multipliers are included in facility/global pipelines and appear in breakdown entries when active.
- Breakdown UI: not verified
- Skill tree migration: code updated, needs play-mode validation + migration spot check
- Skill tree migration: play-mode sanity check reported OK, still need migration spot check on older save

## Notes / Blockers
- `DysonVerseSkillTreeData` bools and `SetSkillsOnOracle` still exist for UI/legacy consumers; full removal remains a large follow-up if you want to eliminate dvst usage entirely.
